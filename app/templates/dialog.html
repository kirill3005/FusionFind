<html><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FusionFind - Современный поиск по товарам</title>
  <style>
    :root {
      --primary-color: #FFDD2D;
      --primary-dark: #FCC521;
      --text-color: #1F2937;
      --bg-light: #FFFAE5;
      --border-color: #E5E7EB;
    }

    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Helvetica', Arial, sans-serif;
      background-color: white;
      color: var(--text-color);
    }

    .header {
      background-color: white;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: #000000;
      text-decoration: none;
    }

    .nav-links {
      display: flex;
      gap: 30px;
      align-items: center;
    }

    .nav-link {
      text-decoration: none;
      color: var(--text-color);
      font-weight: 500;
    }

    .button {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .button:hover {
      background-color: var(--primary-dark);
    }

    .hero {
      padding: 250px 0 180px;
      text-align: center;
      background: linear-gradient(to bottom, var(--bg-light), white);
    }

    .hero h1 {
      font-size: 4em;
      margin-bottom: 20px;
      color: var(--text-color);
    }

    .hero p {
      font-size: 1.2em;
      color: #666;
      margin-bottom: 40px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .features {
      padding: 80px 0;
      background: white;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 40px;
      margin-top: 60px;
    }

    .feature-card {
      text-align: center;
      padding: 30px;
    }

    .feature-icon {
      width: 60px;
      height: 60px;
      margin-bottom: 20px;
      fill: var(--primary-color);
    }

    .feature-card h3 {
      margin-bottom: 15px;
      font-size: 1.5em;
    }

    .feature-card p {
      color: #666;
      line-height: 1.6;
    }

    .auth-button {
      background-color: transparent;
      color: var(--text-color);
      border: 2px solid var(--primary-color);
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      margin-left: 20px;
    }

    .auth-button:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .chat-container {
      max-width: 800px;
      margin: 40px auto;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 60px;
    }

    .chat-title {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-color);
    }

    .chat-description {
      text-align: center;
      max-width: 600px;
      margin: 0 auto 30px;
      color: #666;
      line-height: 1.6;
    }

    .chat-messages {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      background-color: #f8f9fa;
    }

    .chat-input-container {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: white;
      border-top: 1px solid var(--border-color);
    }

    .chat-input {
      flex-grow: 1;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-right: 10px;
      font-size: 14px;
    }

    .chat-controls {
      display: flex;
      gap: 10px;
    }

    .icon-button {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .icon-button:hover {
      background-color: #f3f4f6;
    }

    .icon-button svg {
      width: 24px;
      height: 24px;
      fill: #666;
    }

    .send-button svg {
      fill: var(--primary-color);
    }

    .message {
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      max-width: 80%;
    }

    .user-message {
      background-color: var(--primary-color);
      color: black;
      margin-left: auto;
      margin-right: 10px;
    }

    .bot-message {
      background-color: white;
      color: var(--text-color);
      margin-right: auto;
      margin-left: 10px;
      border: 1px solid var(--border-color);
    }

    #imagePreview {
      display: none;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    #currentImage {
      max-height: 60px;
      border-radius: 4px;
    }

    .message img {
      display: block;
      max-width: 200px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .feedback-container {
      margin-top: 10px;
      padding: 10px;
      border-top: 1px solid var(--border-color);
    }

    .feedback-question {
      margin-bottom: 10px;
      font-size: 14px;
    }

    .feedback-buttons {
      display: flex;
      gap: 10px;
    }

    .feedback-criteria {
      display: none;
      margin-top: 10px;
    }

    .feedback-criteria.active {
      display: block;
    }

    .criteria-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .criteria-item label {
      margin-left: 8px;
      font-size: 14px;
    }

    .feedback-info {
      background-color: var(--bg-light);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.5;
    }

    .feedback-submit {
      display: none;
      margin-top: 15px;
      text-align: left; /* Changed from right to left */
    }

    .feedback-submit.active {
      display: block;
    }

    .feedback-submit .auth-button {
      margin-left: 0; /* Remove left margin since it's now on the left */
      font-size: 14px;
      padding: 8px 16px;
    }

    @media (max-width: 768px) {
      .features-grid {
        grid-template-columns: 1fr;
      }

      .hero h1 {
        font-size: 2.8em;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <a href="/" class="logo">FusionFind</a>
      <nav class="nav-links">
        <a href="/my" class="nav-link">Мои боты</a>
        <a href="/buy-tokens" class="nav-link">Купить токены</a>
        <a href="/my/bots/new" class="button">Создать бота</a>
      </nav>
    </div>
  </header>
  <main>
    <section class="container">
      <p> ф</p>
      <p>ф</p>
      <p style="color: white;">ф</p>
      <h2 class="chat-title">Попробуйте демо-версию поискового бота</h2>
      <p class="chat-description">Этот тестовый чат демонстрирует работу поискового бота. Вы можете отправлять текстовые сообщения и изображения, чтобы увидеть, как работает наша система поиска товаров. Попробуйте описать товар своими словами или загрузить его фотографию.</p>
      <div class="feedback-info">
        <strong>Оцени качество ответов шоппинг ассистента по 3 бинарным метрикам:</strong>
        <br>
        0 - критерий не выполнен, 1 - критерий выполнен
        <br><br>
        Критерии оценки:
        <br>
        1. Адекватность: ассистент ответил на вопрос (пускай даже неправильно), текст понятен и не содержит большого количества ошибок
        <br>
        2. Осознавание ошибок: ответ содержит ошибки, но ассистент их осознаёт и обозначает это
        <br>
        3. Полезность: рекомендованы правильные товары, допускаются небольшие ошибки или неточности
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <!-- Messages will be added here dynamically -->
        </div>
        <div class="chat-input-container">
          <div id="imagePreview" style="display: none;">
            <img id="currentImage" style="display: none;">
            <button class="icon-button" onclick="removeImage()">
              <svg viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
          <input type="text" class="chat-input" placeholder="Введите сообщение..." id="messageInput">
          <div class="chat-controls">
            <input type="file" id="photoInput" accept="image/*" style="display: none">
            <button class="icon-button" onclick="document.getElementById('photoInput').click()">
              <svg viewBox="0 0 24 24">
                <path d="M13.5 9c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5 1.5.67 1.5 1.5zM19 18H5v-7h2.38l1.73-2h6.89l1.73 2H19v7zM21 6h-3.6l-1.73-2H8.33L6.6 6H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
              </svg>
            </button>
            <button class="icon-button send-button" onclick="sendMessageWithImage()">
              <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    async function sendMessage(image = null) {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      const chatMessages = document.getElementById('chatMessages');

      if (message || image) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'user-message');

        if (image && image != 'http://fusionfind.ru/') {
          const img = document.createElement('img');
          img.src = image;
          img.style.maxWidth = '200px';
          img.style.borderRadius = '4px';
          img.style.marginBottom = '8px';
          messageElement.appendChild(img);
        }

        if (message) {
          const textElement = document.createElement('div');
          textElement.textContent = message;
          messageElement.appendChild(textElement);
          input.value = '';
        }

        chatMessages.appendChild(messageElement);


        const botMessage = document.createElement('div');
        botMessage.classList.add('message', 'bot-message');

        const responseText = document.createElement('div');
        responseText.textContent = await getBotResponse(message, image !== null);
        botMessage.appendChild(responseText);

        const feedbackContainer = document.createElement('div');
        feedbackContainer.classList.add('feedback-container');

        const feedbackQuestion = document.createElement('div');
        feedbackQuestion.classList.add('feedback-question');
        feedbackQuestion.textContent = 'Ответил ли ассистент на ваш вопрос?';

        const feedbackButtons = document.createElement('div');
        feedbackButtons.classList.add('feedback-buttons');

        const yesButton = document.createElement('button');
        yesButton.classList.add('button');
        yesButton.textContent = 'Да';
        yesButton.onclick = () => showCriteria(feedbackContainer, message, responseText.textContent);

        const noButton = document.createElement('button');
        noButton.classList.add('auth-button');
        noButton.textContent = 'Нет';
        noButton.onclick = () => hideFeedback(feedbackContainer);

        feedbackButtons.appendChild(yesButton);
        feedbackButtons.appendChild(noButton);

        feedbackContainer.appendChild(feedbackQuestion);
        feedbackContainer.appendChild(feedbackButtons);

        const criteriaSection = document.createElement('div');
        criteriaSection.classList.add('feedback-criteria');

        const criteria = [
            'Адекватность: ассистент ответил на вопрос, текст понятен и без ошибок',
            'Осознавание ошибок: ассистент осознает свои ошибки и обозначает их',
            'Полезность: рекомендованы правильные товары с небольшими неточностями'
          ];

          criteria.forEach((criterion, index) => {
            const criteriaItem = document.createElement('div');
            criteriaItem.classList.add('criteria-item');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `criterion-${index}`;

            const label = document.createElement('label');
            label.htmlFor = `criterion-${index}`;
            label.textContent = criterion;

            criteriaItem.appendChild(checkbox);
            criteriaItem.appendChild(label);
            criteriaSection.appendChild(criteriaItem);
          });

          feedbackContainer.appendChild(criteriaSection);
          botMessage.appendChild(feedbackContainer);

          chatMessages.appendChild(botMessage);
          chatMessages.scrollTop = chatMessages.scrollHeight;


        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
    async function getBotResponse(message, image) {
        const conversationId = '{{ conv_id }}';
        if (image) {
        const response = await fetch('http://api.fusionfind.ru/message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            api_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzM1OTAwNTY5fQ.xTojJvrfusApuHQzkK8fCw-WCNgYexnerYlVJ0a1bis",
            db_token: "MS14eGZfM29yalVnY2VqbU5DTmVabjlRPT0",
            conversation_id: conversationId, // Динамическое значение из шаблона
            message: message,
            photo: image             // Параметр функции
            })});
        const result = await response.json();
        return result.response;}
        else
        {
          const response = await fetch('http://api.fusionfind.ru/message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            api_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiZXhwIjoxNzM1OTAwNTY5fQ.xTojJvrfusApuHQzkK8fCw-WCNgYexnerYlVJ0a1bis",
            db_token: "MS14eGZfM29yalVnY2VqbU5DTmVabjlRPT0",
            conversation_id: conversationId, // Динамическое значение из шаблона
            message: message,
            photo: "None"                 // Параметр функции
            })});
        const result = await response.json();
        return result.response;
        }
    }

    window.onload = function() {
      const chatMessages = document.getElementById('chatMessages');
      
      const welcomeMessage = document.createElement('div');
      welcomeMessage.classList.add('message', 'bot-message');
      welcomeMessage.textContent = "Здравствуйте! Прошу вас скачать фото образа и отправить его боту с просьбой найти товар, как на фото, написав для этого промпт модели.";
      chatMessages.appendChild(welcomeMessage);
      const img = document.createElement('img');
      img.src = '{{look.image}}';
      img.style.maxWidth = '200px';
      img.style.borderRadius = '4px';
      img.style.marginBottom = '8px';
      welcomeMessage.appendChild(img);
      const img_sim = document.createElement('img');
      img_sim.src = '{{look.similar}}';
      img_sim.style.maxWidth = '200px';
      img_sim.style.borderRadius = '4px';
      img_sim.style.marginBottom = '8px';
      welcomeMessage.appendChild(img_sim);

    }

    const input = document.getElementById('messageInput');
      input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendMessageWithImage();
        }
      });

    document.getElementById('photoInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('currentImage').src = e.target.result;
          document.getElementById('imagePreview').style.display = 'flex';
        }
        reader.readAsDataURL(file);
      }
    });

    function removeImage() {
      document.getElementById('currentImage').src = '';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('photoInput').value = '';
    }

    function sendMessageWithImage() {
      const imageSrc = document.getElementById('currentImage').src;
      sendMessage(imageSrc || null);
      if (imageSrc) {
        removeImage();
      }
    }
    function showCriteria(container, user, bot) {
      const criteriaSection = container.querySelector('.feedback-criteria');
      criteriaSection.classList.add('active');

      // Remove existing submit button if present
      const existingSubmit = container.querySelector('.feedback-submit');
      if (existingSubmit) {
        existingSubmit.remove();
      }

      // Create submit button
      const submitContainer = document.createElement('div');
      submitContainer.classList.add('feedback-submit');
      submitContainer.classList.add('active');

      const submitButton = document.createElement('button');
      submitButton.classList.add('auth-button'); // Changed from 'button' to 'auth-button'
      submitButton.textContent = 'Отправить оценку';
      submitButton.onclick = () => submitFeedback(container, user, bot);

      submitContainer.appendChild(submitButton);
      criteriaSection.appendChild(submitContainer);
    }

    async function submitFeedback(container, user, bot) {
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const feedback = Array.from(checkboxes).map(checkbox => checkbox.checked ? 1 : 0);

      const response = await fetch('/scores', {
        method: 'POST',
        headers: {
                        'Content-Type': 'application/json'
                    },
                body: JSON.stringify({adekv: feedback[0],
                mistakes: feedback[1],
                useful: feedback[2],
                username: '{{username}}',
                user_msg: user,
                model_msg: bot})
      })

      // Hide the feedback container
      hideFeedback(container);
    }

    function hideFeedback(container) {
      container.style.display = 'none';
    }
  </script>
</body></html>